<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clase</title>
  <style>
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
      color: #333;
    }
    header {
      background-color: #2c3e50;
      color: #ecf0f1;
      padding: 1.5rem;
      text-align: center;
      font-size: 1.5rem;
    }
    nav {
      display: flex;
      justify-content: center;
      background-color: #34495e;
      border-bottom: 2px solid #2980b9;
    }
    nav a {
      color: #ecf0f1;
      padding: 1rem 1.5rem;
      text-decoration: none;
      font-weight: bold;
    }
    nav a:hover {
      background-color: #2980b9;
      color: white;
    }
    nav a.active {
      background-color: #2980b9;
      color: white;
    }
    main {
      padding: 2rem;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .card {
      background-color: #ffffff;
      border: 1px solid #bdc3c7;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: transform 0.2s;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    .form-group {
      margin-bottom: 1.5rem;
    }
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: #2c3e50;
      font-weight: bold;
    }
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #bdc3c7;
      border-radius: 4px;
      background-color: #ecf0f1;
      color: #333;
      font-size: 1rem;
    }
    button {
      background-color: #2980b9;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.2s;
    }
    button:hover {
      background-color: #3498db;
    }
    .hidden {
      display: none;
    }
    .recuadro {
      background-color: #ffffff;
      border: 1px solid #bdc3c7;
      padding: 1.5rem;
      border-radius: 8px;
      margin-top: 1.5rem;
    }
    .recuadro h4 {
      margin-top: 0;
      color: #2c3e50;
    }
    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #ffffff;
      border: 1px solid #bdc3c7;
      border-radius: 8px;
      padding: 2rem;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      width: 90%;
      max-width: 600px;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 999;
    }
    .clickable {
      color: #2980b9;
      text-decoration: none;
      cursor: pointer;
    }
    .clickable:hover {
      color: #3498db;
    }
    .form-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 999;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .form-modal {
      background-color: white;
      padding: 2rem;
      border-radius: 8px;
      max-width: 500px;
      width: 90%;
    }
    .entidad-item, .persona-item {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 5px;
    }
    .entidad-item input[type="checkbox"] {
      margin: 0;
    }
    .acciones-lista {
      width: 100%;
      padding: 20px;
    }
    .accion-card {
      background-color: #f9f9f9;
      border: 1px solid #b71c1c;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      text-decoration: none !important;
    }
    .accion-card:hover {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    .accion-card * {
      text-decoration: none !important;
    }
    .accion-fecha {
      color: #f71616;
      font-weight: normal;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Clase</h1>
  </header>
  <nav>
    <a href="#" onclick="mostrarSeccion('conflictos')" id="nav-conflictos">Conflictos</a>
    <a href="#" onclick="mostrarSeccion('acciones')" id="nav-acciones">Acciones</a>
    <a href="#" onclick="mostrarSeccion('bd')" id="nav-admin">Admin</a>
  </nav>
  <main class="container">
    <!-- Sección Inicio -->
    <!--
    <section id="inicio" class="seccion">
      <h2>Bienvenido</h2>
      <p>Esta plataforma permite registrar y gestionar conflictos laborales, entidades involucradas, personas y acciones relacionadas.</p>
    </section>
    -->

    <!-- Sección Conflictos -->
    <section id="conflictos" class="seccion hidden">
      <div id="lista-conflictos"></div>
    </section>

    <!-- Sección Acciones -->
    <section id="acciones" class="seccion">
      <div id="acciones-contenedor"></div>
    </section>

    <!-- Sección Admin -->
    <section id="admin" class="seccion hidden">
      <h2>Panel de Administración</h2>
      <div id="login-form" class="admin-section">
        <h3>Iniciar Sesión</h3>
        <div class="form-group">
          <label for="password">Contraseña</label>
          <input type="password" id="password" required>
        </div>
        <button onclick="iniciarSesion()">Ingresar</button>
      </div>
      <div id="admin-dashboard" class="hidden">
        <h3>Dashboard</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 20px;">
          <button onclick="mostrarFormularioConflicto()">Agregar Conflicto</button>
          <button onclick="mostrarListaConflictos()">Gestionar Conflictos</button>
          <button onclick="mostrarGestionPartes()">Gestionar Partes</button>
          <button onclick="mostrarGestionPersonas()">Gestionar Personas</button>
          <button onclick="mostrarGestionAcciones()">Gestionar Acciones</button>
        </div>
        <div id="formulario-conflicto" class="hidden">
          <h3>Agregar/Editar Conflicto</h3>
          <div class="form-group">
            <label for="titulo">Título</label>
            <input type="text" id="titulo" required>
          </div>
          <div class="form-group">
            <label for="descripcion">Descripción</label>
            <textarea id="descripcion" rows="3" required></textarea>
          </div>
          <div class="form-group">
            <label for="fecha_inicio">Inicio</label>
            <input type="date" id="fecha_inicio" required>
          </div>
          <div class="form-group">
            <label for="estado">Estado</label>
            <select id="estado">
              <option value="activo">Activo</option>
              <option value="resuelto">Finalizado</option>
            </select>
          </div>
          <div class="form-group">
            <label for="ubicacion">Ubicación</label>
            <input type="text" id="ubicacion" required>
          </div>
          <div class="recuadro">
            <h4>Entidades</h4>
            <ul id="entidades-lista-conflicto"></ul>
            <button onclick="agregarEntidadAConflicto()">Agregar Entidad</button>
          </div>
          <div class="recuadro">
            <h4>Personas</h4>
            <ul id="personas-lista-conflicto"></ul>
            <button onclick="agregarPersonaAConflicto()">Agregar Persona</button>
          </div>
          <div class="recuadro">
            <h4>Acciones</h4>
            <ul id="acciones-lista-conflicto"></ul>
            <button onclick="agregarAccionAConflicto()">Agregar Acción</button>
          </div>
          <button onclick="guardarConflicto()">Guardar</button>
        </div>
        <div id="lista-conflictos-admin" class="hidden">
          <h3>Gestionar Conflictos</h3>
          <div id="conflictos-lista"></div>
        </div>
        <div id="gestion-partes" class="hidden">
          <h3>Gestionar Partes</h3>
          <button onclick="mostrarFormularioNuevaParte()">Agregar Parte</button>
          <div id="lista-partes"></div>
        </div>
        <div id="gestion-personas" class="hidden">
          <h3>Gestionar Personas</h3>
          <button onclick="mostrarFormularioNuevaPersona()">Agregar Persona</button>
          <div id="lista-personas"></div>
        </div>
        <div id="gestion-acciones" class="hidden">
          <h3>Gestionar Acciones</h3>
          <button onclick="mostrarFormularioNuevaAccion()">Agregar Acción</button>
          <div id="lista-acciones-admin"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal -->
  <div id="modal" class="modal hidden">
    <h3 id="modal-titulo">Detalles</h3>
    <div id="modal-contenido"></div>
    <button onclick="cerrarModal()">Cerrar</button>
  </div>
  <div id="modal-overlay" class="modal-overlay hidden"></div>

  <script>
    const BASE_URL = "https://api.jsonbin.io/v3/b/67b7af37e41b4d34e49614cb";
    const API_KEY = "$2a$10$g6sH3FZZb2lLbX6sdlo7Eeq4pSp3prxRk//ZurGqxwpFs2jECn.US";
    const ACCESS_KEY = "$2a$10$DPXPqteMvbeGS75DZo25vOUxM.8HjLW7fo/dqYpjk0S88JtC/k/BG";

    const headers = {
      "Content-Type": "application/json",
      "X-Master-Key": API_KEY,
      "X-Access-Key": ACCESS_KEY
    };

    let datosActuales = null;
    let conflictoEditando = null;

    async function obtenerDatos() {
      try {
        const response = await fetch(BASE_URL, { headers });
        if (!response.ok) throw new Error("Error al obtener datos");
        const data = await response.json();
        datosActuales = data.record;
        return datosActuales;
      } catch (error) {
        console.error("Error al obtener datos:", error.message);
        alert("No se pudieron cargar los datos. Inténtalo nuevamente.");
      }
    }

    async function actualizarDatos(nuevosDatos) {
      try {
        const response = await fetch(BASE_URL, {
          method: "PUT",
          headers,
          body: JSON.stringify(nuevosDatos)
        });
        if (!response.ok) throw new Error("Error al actualizar datos");
      } catch (error) {
        console.error("Error al actualizar datos:", error.message);
        alert("No se pudieron guardar los cambios. Inténtalo nuevamente.");
      }
    }

    async function cargarDatos() {
      datosActuales = await obtenerDatos();
      mostrarConflictos();
    }

    function mostrarSeccion(seccion) {
      // Ocultar todas las secciones primero
      const secciones = ['conflictos', 'acciones', 'admin']
      secciones.forEach(sec => {
        const elemento = document.getElementById(sec)
        if (elemento) elemento.classList.add('hidden')
      })
      
      // Mostrar la sección seleccionada
      const seccionSeleccionada = document.getElementById(seccion)
      if (seccionSeleccionada) {
        seccionSeleccionada.classList.remove('hidden')
      }
      
      // Actualizar navegación activa
      document.querySelectorAll('nav a').forEach(a => {
        a.classList.remove('active')
      })
      const navActivo = document.getElementById(`nav-${seccion}`)
      if (navActivo) {
        navActivo.classList.add('active')
      }

      // Cargar el contenido específico
      if (seccion === 'conflictos') {
        mostrarConflictos()
      } else if (seccion === 'acciones') {
        mostrarAcciones()
      }

      // Prevenir el comportamiento por defecto del enlace
      return false
    }

    function mostrarConflictos() {
      const contenedor = document.getElementById("lista-conflictos")
      contenedor.innerHTML = ""
      
      if (datosActuales && datosActuales.conflictos && datosActuales.conflictos.length > 0) {
        const conflictosOrdenados = datosActuales.conflictos.map(conflicto => {
          const acciones = datosActuales.acciones.filter(a => a.id_conflicto === conflicto.id)
          const ultimaAccion = acciones.length > 0 
            ? acciones.reduce((a, b) => new Date(a.fecha) > new Date(b.fecha) ? a : b)
            : null
          return {
            ...conflicto,
            ultimaAccion
          }
        }).sort((a, b) => {
          if (!a.ultimaAccion) return 1
          if (!b.ultimaAccion) return -1
          return new Date(b.ultimaAccion.fecha) - new Date(a.ultimaAccion.fecha)
        })

        conflictosOrdenados.forEach((conflicto) => {
          const card = document.createElement("div")
          card.className = "card"
          const duracion = calcularDuracion(conflicto.fecha_inicio)
          
          let ultimaAccionTexto = ''
          if (conflicto.ultimaAccion) {
            const diasDesdeUltimaAccion = Math.floor(
              (new Date() - new Date(conflicto.ultimaAccion.fecha)) / (1000 * 60 * 60 * 24)
            )
            ultimaAccionTexto = `
              <div class="ultima-accion">
                <span style="color: #f71616;">Última acción | </span>
                <span style="color: #f71616;">${capitalizarPrimeraLetra(conflicto.ultimaAccion.tipo_accion)}</span>
                <span style="color: #f71616;"> hace ${diasDesdeUltimaAccion} días</span>
              </div>`
          }

          card.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <h3 style="margin: 0;">${conflicto.titulo}</h3>
              <span style="color: #f71616; font-weight: bold;">Día ${duracion}</span>
            </div>
            <p>${conflicto.descripcion}</p>
            ${ultimaAccionTexto}
          `
          card.onclick = () => mostrarFichaConflicto(conflicto.id)
          contenedor.appendChild(card)
        })
      } else {
        contenedor.innerHTML = "<p>No hay conflictos registrados.</p>"
      }
    }

    function calcularDuracion(fechaInicio) {
      const fechaInicioDate = new Date(fechaInicio);
      const hoy = new Date();
      const diferencia = Math.floor((hoy - fechaInicioDate) / (1000 * 60 * 60 * 24));
      return diferencia + 1; // Día 1 es el día de inicio
    }

    function capitalizarPrimeraLetra(string) {
      if (!string) return '';
      return string.charAt(0).toUpperCase() + string.slice(1);
    }

    function mostrarFichaConflicto(id) {
      const conflicto = datosActuales.conflictos.find((c) => c.id === id);
      if (!conflicto) return;

      const accionesRelacionadas = datosActuales.acciones
        .filter((a) => a.id_conflicto === id)
        .map(a => {
          const diasDesdeInicio = calcularDuracion(conflicto.fecha_inicio, a.fecha) + 1; // Sumar 1 para incluir el día de inicio
          return {
            ...a,
            dias: diasDesdeInicio
          };
        })
        .sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

      const modalId = `modal-${Date.now()}`;
      const modal = document.createElement("div");
      modal.id = modalId;
      modal.className = "modal";
      
      const overlay = document.createElement("div");
      overlay.className = "modal-overlay";
      overlay.onclick = () => cerrarModalEspecifico(modalId);

      let contenido = `
        <h3 style="text-align: center;">${conflicto.titulo}</h3>
        <table style="line-height: 1.5;">
          <tr>
            <th>Descripción:</th>
            <td>${conflicto.descripcion}</td>
          </tr>
          <tr>
            <th>Fecha de inicio:</th>
            <td>${conflicto.fecha_inicio}</td>
          </tr>
          <tr>
            <th>Ubicación:</th>
            <td>${conflicto.ubicacion || 'No especificada'}</td>
          </tr>
          <tr>
            <th>Duración:</th>
            <td>${calcularDuracion(conflicto.fecha_inicio)} días</td>
          </tr>
          <tr>
            <th>Estado:</th>
            <td>${conflicto.estado}</td>
          </tr>
          <tr>
            <th>Acciones:</th>
            <td>
              <ul class="acciones-lista" style="list-style: none; padding: 0;">
                ${accionesRelacionadas.map((a) => `
                  <li class="clickable" onclick="mostrarFichaElemento('accion', ${a.id})" style="margin-bottom: 8px;">
                    <span style="color: #f71616;">Día ${a.dias} | ${capitalizarPrimeraLetra(a.tipo_accion)}</span>
                    <span style="color: #000000;"> | ${a.descripcion}</span>
                  </li>
                `).join("")}
              </ul>
            </td>
          </tr>
        </table>
      `;

      modal.innerHTML = `
        ${contenido}
        <button onclick="cerrarModalEspecifico('${modalId}')">Cerrar</button>
      `;

      document.body.appendChild(overlay);
      document.body.appendChild(modal);
    }

    function calcularTiempoTranscurrido(fecha) {
      const ahora = new Date();
      const fechaAccion = new Date(fecha);
      const diferenciaEnMilisegundos = ahora - fechaAccion;
      const diferenciaEnHoras = Math.floor(diferenciaEnMilisegundos / (1000 * 60 * 60));
      const diferenciaEnDias = Math.floor(diferenciaEnMilisegundos / (1000 * 60 * 60 * 24));

      if (diferenciaEnHoras < 1) return "hace menos de una hora"; // Si es menos de una hora
      if (diferenciaEnHoras === 1) return "hace 1 hora"; // Si fue hace una hora
      if (diferenciaEnHoras < 24) return `hace ${diferenciaEnHoras} horas`; // Si fue hace menos de un día
      if (diferenciaEnDias === 1) return "hace 1 día"; // Si fue hace un día
      return `hace ${diferenciaEnDias} días`; // Para más de un día
    }

    function mostrarFichaElemento(tipo, id) {
      const modalId = `modal-${Date.now()}`
      const modal = document.createElement('div')
      modal.id = modalId
      modal.className = 'modal'
      
      const overlay = document.createElement('div')
      overlay.className = 'modal-overlay'

      let contenido = ""
      let elemento

      if (tipo === "accion") {
        elemento = datosActuales.acciones.find(a => a.id === id)
        if (elemento) {
          const conflicto = datosActuales.conflictos.find(c => c.id === elemento.id_conflicto)
          const entidadesAccion = elemento.entidades_relacionadas
            ? elemento.entidades_relacionadas
              .map(idEnt => datosActuales.entidades.find(e => e.id === idEnt))
              .filter(e => e)
              .map(e => e.nombre)
              .join(", ")
            : 'No especificadas'

          contenido = `
            <h3 style="text-align: center;">${conflicto ? conflicto.titulo : 'Conflicto no especificado'}</h3>
            <table style="line-height: 1.5;">
              <tr>
                <th>Fecha</th>
                <td style="font-size: 0.8em; color: #666;">${elemento.fecha}</td>
              </tr>
              <tr>
                <th>Tipo de Acción</th>
                <td>${capitalizarPrimeraLetra(elemento.tipo_accion)}</td>
              </tr>
              <tr>
                <th>Descripción</th>
                <td>${elemento.descripcion}</td>
              </tr>
              <tr>
                <th>Parte</th>
                <td>${entidadesAccion || 'No especificadas'}</td>
              </tr>
            </table>
          `
        }
      } else if (tipo === "conflicto") {
        elemento = datosActuales.conflictos.find(c => c.id === id)
        if (elemento) {
          contenido = `
            <h3 style="text-align: center;">${elemento.titulo}</h3>
            <table style="line-height: 1.5;">
              <tr>
                <th>Descripción</th>
                <td>${elemento.descripcion}</td>
              </tr>
              <tr>
                <th>Inicio</th>
                <td>${elemento.fecha_inicio}</td>
              </tr>
              <tr>
                <th>Estado</th>
                <td>${elemento.estado}</td>
              </tr>
              <tr>
                <th>Ubicación</th>
                <td>${elemento.ubicacion || 'No especificada'}</td>
              </tr>
            </table>
          `
        }
      } else if (tipo === "entidad") {
        elemento = datosActuales.entidades.find(e => e.id === id)
        if (elemento) {
          contenido = `
            <h3>Ficha de Entidad</h3>
            <p><strong>Nombre:</strong> ${elemento.nombre}</p>
            <p><strong>Tipo:</strong> ${elemento.tipo}</p>
          `
        }
      } else if (tipo === "persona") {
        elemento = datosActuales.personas.find(p => p.id === id)
        if (elemento) {
          let entidadesPersona = 'No hay entidades asociadas'
          
          if (elemento.entidades_relacionadas) {
            entidadesPersona = elemento.entidades_relacionadas
              .map(idEnt => datosActuales.entidades.find(e => e.id === idEnt))
              .filter(e => e)
              .map(e => `<li class="clickable" onclick="mostrarFichaElemento('entidad', ${e.id})">${e.nombre}</li>`)
              .join('')
          }

          contenido = `
            <h3>Ficha de Persona</h3>
            <p><strong>Nombre:</strong> ${elemento.nombre}</p>
            <p><strong>Rol:</strong> ${elemento.rol}</p>
            <h4>Entidades relacionadas:</h4>
            <ul>${entidadesPersona}</ul>
          `
        }
      }

      if (!elemento) {
        alert("Elemento no encontrado")
        return
      }

      modal.innerHTML = `
        ${contenido}
        <button onclick="cerrarModalEspecifico('${modalId}')">Cerrar</button>
      `

      document.body.appendChild(overlay)
      document.body.appendChild(modal)
    }

    function cerrarModalEspecifico(modalId) {
      const modal = document.getElementById(modalId);
      const overlay = modal.previousElementSibling;
      modal.remove();
      overlay.remove();
    }

    function cerrarModal() {
      document.getElementById("modal").classList.add("hidden");
      document.getElementById("modal-overlay").classList.add("hidden");
    }

    function iniciarSesion() {
      const password = document.getElementById("password").value;
      if (password === "admin123") {
        document.getElementById("login-form").classList.add("hidden");
        document.getElementById("admin-dashboard").classList.remove("hidden");
        cargarDatos();
      } else {
        alert("Contraseña incorrecta.");
      }
    }

    function mostrarFormularioConflicto(id = null) {
      const formulario = document.getElementById("formulario-conflicto");

      // Limpiar listas previas
      document.getElementById("entidades-lista-conflicto").innerHTML = "";
      document.getElementById("personas-lista-conflicto").innerHTML = "";
      document.getElementById("acciones-lista-conflicto").innerHTML = "";

      if (id) {
        const conflicto = datosActuales.conflictos.find((c) => c.id === id);
        if (!conflicto) {
          alert("Conflicto no encontrado.");
          return;
        }

        document.getElementById("titulo").value = conflicto.titulo;
        document.getElementById("descripcion").value = conflicto.descripcion;
        document.getElementById("fecha_inicio").value = conflicto.fecha_inicio;
        document.getElementById("estado").value = conflicto.estado;
        document.getElementById("ubicacion").value = conflicto.ubicacion;

        // Cargar entidades relacionadas
        conflicto.entidades_involucradas.forEach((idEntidad) => {
          const entidad = datosActuales.entidades.find((e) => e.id === idEntidad);
          if (entidad) {
            agregarItemALista(entidad, "entidades-lista-conflicto");
          }
        });

        // Cargar personas relacionadas
        conflicto.personas_involucradas.forEach((idPersona) => {
          const persona = datosActuales.personas.find((p) => p.id === idPersona);
          if (persona) {
            agregarItemALista(persona, "personas-lista-conflicto");
          }
        });

        // Cargar acciones relacionadas
        const accionesConflicto = datosActuales.acciones.filter((a) => a.id_conflicto === id);
        accionesConflicto.forEach((accion) => {
          const li = document.createElement("li");
          li.innerHTML = `
            ${accion.tipo_accion} (${accion.fecha})
            <button onclick="editarAccion(${accion.id})">Editar</button>
            <button onclick="eliminarAccion(${accion.id})">Eliminar</button>
          `;
          document.getElementById("acciones-lista-conflicto").appendChild(li);
        });

        conflictoEditando = id;
      } else {
        document.getElementById("titulo").value = "";
        document.getElementById("descripcion").value = "";
        document.getElementById("fecha_inicio").value = "";
        document.getElementById("estado").value = "activo";
        document.getElementById("ubicacion").value = "";
        conflictoEditando = null;
      }

      formulario.classList.remove("hidden");
    }

    function agregarItemALista(item, listaId) {
      const lista = document.getElementById(listaId);
      
      if (listaId === "acciones-lista-conflicto") {
        lista.innerHTML = "";
        datosActuales.acciones
          .filter(accion => accion.id_conflicto === conflictoEditando)
          .forEach(accion => {
            const li = document.createElement("li");
            li.setAttribute('data-id', accion.id);
            li.innerHTML = `
              ${accion.tipo_accion} (${accion.fecha})
              <button onclick="editarAccion(${accion.id})">Editar</button>
              <button onclick="eliminarAccion(${accion.id})">Eliminar</button>
            `;
            lista.appendChild(li);
          });
      } else {
        const li = document.createElement("li");
        li.setAttribute('data-id', item.id);
        li.innerHTML = `
          ${item.nombre || item.tipo_accion}
          <button onclick="editar${item.tipo ? 'Entidad' : 'Persona'}(${item.id})">Editar</button>
          <button onclick="eliminar${item.tipo ? 'Entidad' : 'Persona'}(${item.id})">Eliminar</button>
        `;
        lista.appendChild(li);
      }
    }

    function editarEntidad(id) {
      const entidad = datosActuales.entidades.find(e => e.id === id);
      if (!entidad) return;

      const formHTML = `
        <div class="form-overlay">
          <div class="form-modal">
            <h3>Editar Entidad</h3>
            <div class="form-group">
              <label for="nombre-entidad">Nombre</label>
              <input type="text" id="nombre-entidad" value="${entidad.nombre}" required>
            </div>
            <div class="form-group">
              <label for="tipo-entidad">Tipo</label>
              <select id="tipo-entidad">
                <option value="empresa" ${entidad.tipo === 'empresa' ? 'selected' : ''}>Empresa</option>
                <option value="sindicato" ${entidad.tipo === 'sindicato' ? 'selected' : ''}>Sindicato</option>
                <option value="gobierno" ${entidad.tipo === 'gobierno' ? 'selected' : ''}>Gobierno</option>
                <option value="otro" ${entidad.tipo === 'otro' ? 'selected' : ''}>Otro</option>
              </select>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
              <button onclick="cerrarFormularioFlotante(this)">Cancelar</button>
              <button onclick="actualizarEntidad(${id}, this)">Guardar</button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', formHTML);
    }

    function editarPersona(id) {
      const persona = datosActuales.personas.find(p => p.id === id);
      if (!persona) return;

      const entidadesOptions = datosActuales.entidades.map(e => 
        `<div class="entidad-item">
          <input type="checkbox" id="entidad-${e.id}" value="${e.id}" 
            ${persona.entidades_relacionadas.includes(e.id) ? 'checked' : ''}>
          <label for="entidad-${e.id}">${e.nombre} (${e.tipo})</label>
        </div>`
      ).join('');

      const formHTML = `
        <div class="form-overlay">
          <div class="form-modal">
            <h3>Editar Persona</h3>
            <div class="form-group">
              <label for="nombre-persona">Nombre</label>
              <input type="text" id="nombre-persona" value="${persona.nombre}" required>
            </div>
            <div class="form-group">
              <label for="rol-persona">Rol</label>
              <select id="rol-persona">
                <option value="trabajador" ${persona.rol === 'trabajador' ? 'selected' : ''}>Trabajador</option>
                <option value="delegado" ${persona.rol === 'delegado' ? 'selected' : ''}>Delegado</option>
                <option value="directivo" ${persona.rol === 'directivo' ? 'selected' : ''}>Directivo</option>
                <option value="funcionario" ${persona.rol === 'funcionario' ? 'selected' : ''}>Funcionario</option>
                <option value="otro" ${persona.rol === 'otro' ? 'selected' : ''}>Otro</option>
              </select>
            </div>
            <div class="form-group">
              <label>Entidades relacionadas</label>
              <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px;">
                ${entidadesOptions}
              </div>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
              <button onclick="cerrarFormularioFlotante(this)">Cancelar</button>
              <button onclick="actualizarPersona(${id}, this)">Guardar</button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', formHTML);
    }

    function editarAccion(id) {
      const accion = datosActuales.acciones.find(a => a.id === id);
      if (!accion) return;

      // Asegurarse de que entidades_relacionadas existe
      accion.entidades_relacionadas = accion.entidades_relacionadas || [];

      const entidadesOptions = datosActuales.entidades.map(e => 
        `<div class="entidad-item">
          <input type="checkbox" id="entidad-${e.id}" value="${e.id}" 
            ${accion.entidades_relacionadas.includes(e.id) ? 'checked' : ''}>
          <label for="entidad-${e.id}">${e.nombre} (${e.tipo})</label>
        </div>`
      ).join('');

      const formHTML = `
        <div class="form-overlay">
          <div class="form-modal">
            <h3>Editar Acción</h3>
            <div class="form-group">
              <label for="tipo-accion">Tipo de Acción</label>
              <select id="tipo-accion">
                <option value="paro" ${accion.tipo_accion === 'paro' ? 'selected' : ''}>Paro</option>
                <option value="movilización" ${accion.tipo_accion === 'movilización' ? 'selected' : ''}>Movilización</option>
                <option value="asamblea" ${accion.tipo_accion === 'asamblea' ? 'selected' : ''}>Asamblea</option>
                <option value="negociación" ${accion.tipo_accion === 'negociación' ? 'selected' : ''}>Negociación</option>
                <option value="otro" ${accion.tipo_accion === 'otro' ? 'selected' : ''}>Otro</option>
              </select>
            </div>
            <div class="form-group">
              <label for="fecha-accion">Fecha</label>
              <input type="date" id="fecha-accion" value="${accion.fecha}" required>
            </div>
            <div class="form-group">
              <label for="descripcion-accion">Descripción</label>
              <textarea id="descripcion-accion" rows="3" required>${accion.descripcion}</textarea>
            </div>
            <div class="form-group">
              <label>Entidades involucradas</label>
              <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px;">
                ${entidadesOptions}
              </div>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
              <button onclick="cerrarFormularioFlotante(this)">Cancelar</button>
              <button onclick="actualizarAccion(${id}, this)">Guardar</button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', formHTML);
    }

    function cerrarFormularioFlotante(element) {
      const formOverlay = element.closest('.form-overlay');
      if (formOverlay) {
        formOverlay.remove();
      }
    }

    function actualizarAccion(id, element) {
      const form = element.closest('.form-modal');
      const tipo = form.querySelector('#tipo-accion').value;
      const fecha = form.querySelector('#fecha-accion').value;
      const descripcion = form.querySelector('#descripcion-accion').value;
      const entidadesSeleccionadas = Array.from(form.querySelectorAll('input[type="checkbox"]:checked'))
        .map(checkbox => parseInt(checkbox.value));

      if (!tipo || !fecha || !descripcion) {
        alert('Por favor, completa todos los campos');
        return;
      }

      const index = datosActuales.acciones.findIndex(a => a.id === id);
      if (index !== -1) {
        datosActuales.acciones[index] = {
          ...datosActuales.acciones[index],
          tipo_accion: tipo,
          fecha,
          descripcion,
          entidades_relacionadas: entidadesSeleccionadas
        };
        actualizarDatos(datosActuales);
        cerrarFormularioFlotante(element);
        mostrarFormularioConflicto(conflictoEditando);
      }
    }

    function actualizarEntidad(id, element) {
      const form = element.closest('.form-modal');
      const nombre = form.querySelector('#nombre-entidad').value;
      const tipo = form.querySelector('#tipo-entidad').value;

      if (!nombre) {
        alert('Por favor, completa el nombre de la entidad');
        return;
      }

      const index = datosActuales.entidades.findIndex(e => e.id === id);
      if (index !== -1) {
        datosActuales.entidades[index] = { ...datosActuales.entidades[index], nombre, tipo };
        actualizarDatos(datosActuales);
        cerrarFormularioFlotante(element);
        mostrarConflictos();
      }
    }

    function actualizarPersona(id, element) {
      const form = element.closest('.form-modal');
      const nombre = form.querySelector('#nombre-persona').value;
      const rol = form.querySelector('#rol-persona').value;
      const entidadesSeleccionadas = Array.from(form.querySelectorAll('input[type="checkbox"]:checked'))
        .map(checkbox => parseInt(checkbox.value));

      if (!nombre) {
        alert('Por favor, completa el nombre de la persona');
        return;
      }

      const index = datosActuales.personas.findIndex(p => p.id === id);
      if (index !== -1) {
        datosActuales.personas[index] = {
          ...datosActuales.personas[index],
          nombre,
          rol,
          entidades_relacionadas: entidadesSeleccionadas
        };
        actualizarDatos(datosActuales);
        cerrarFormularioFlotante(element);
        mostrarConflictos();
      }
    }

    function eliminarEntidad(id) {
      if (confirm('¿Estás seguro de que deseas eliminar esta entidad?')) {
        datosActuales.entidades = datosActuales.entidades.filter(e => e.id !== id);
        actualizarDatos(datosActuales);
        mostrarConflictos();
      }
    }

    function eliminarPersona(id) {
      if (confirm('¿Estás seguro de que deseas eliminar esta persona?')) {
        datosActuales.personas = datosActuales.personas.filter(p => p.id !== id);
        actualizarDatos(datosActuales);
        mostrarConflictos();
      }
    }

    function eliminarAccion(id) {
      if (confirm('¿Estás seguro de que deseas eliminar esta acción?')) {
        datosActuales.acciones = datosActuales.acciones.filter(a => a.id !== id);
        actualizarDatos(datosActuales);
        mostrarConflictos();
      }
    }

    async function guardarConflicto() {
      const titulo = document.getElementById("titulo").value;
      const descripcion = document.getElementById("descripcion").value;
      const fecha_inicio = document.getElementById("fecha_inicio").value;
      const estado = document.getElementById("estado").value;
      const ubicacion = document.getElementById('ubicacion').value;

      if (!titulo || !descripcion || !fecha_inicio || !estado || !ubicacion) {
        alert("Por favor, completa todos los campos del conflicto.");
        return;
      }

      // Obtener las entidades y personas relacionadas directamente de los elementos del DOM
      const entidades_involucradas = Array.from(document.querySelectorAll("#entidades-lista-conflicto li"))
        .map(li => parseInt(li.getAttribute('data-id')))
        .filter(id => !isNaN(id));

      const personas_involucradas = Array.from(document.querySelectorAll("#personas-lista-conflicto li"))
        .map(li => parseInt(li.getAttribute('data-id')))
        .filter(id => !isNaN(id));

      const nuevoConflicto = {
        id: conflictoEditando || Date.now(),
        titulo,
        descripcion,
        fecha_inicio,
        estado,
        ubicacion,
        entidades_involucradas,
        personas_involucradas
      };

      if (conflictoEditando) {
        const index = datosActuales.conflictos.findIndex((c) => c.id === conflictoEditando);
        datosActuales.conflictos[index] = nuevoConflicto;
      } else {
        datosActuales.conflictos.push(nuevoConflicto);
      }

      await actualizarDatos(datosActuales);
      mostrarConflictos();
      cerrarFormularioConflicto();
      alert("Conflicto guardado con éxito.");
    }

    function cerrarFormularioConflicto() {
      document.getElementById("formulario-conflicto").classList.add("hidden");
    }

    function mostrarListaConflictos() {
      mostrarSeccion("admin");
      document.getElementById("lista-conflictos-admin").classList.remove("hidden");

      const contenedor = document.getElementById("conflictos-lista");
      contenedor.innerHTML = "";

      if (datosActuales && datosActuales.conflictos && datosActuales.conflictos.length > 0) {
        datosActuales.conflictos.forEach((conflicto) => {
          const card = document.createElement("div");
          card.className = "card";
          const duracion = calcularDuracion(conflicto.fecha_inicio);

          card.innerHTML = `
            <p style="color: #f71616; font-weight: bold; margin-bottom: 8px;">Día ${duracion}</p>
            <h3>${conflicto.titulo}</h3>
            <p>${conflicto.descripcion}</p>
            <button onclick="editarConflicto(${conflicto.id})">Editar</button>
            <button onclick="eliminarConflicto(${conflicto.id})">Eliminar</button>
          `;
          contenedor.appendChild(card);
        });
      } else {
        contenedor.innerHTML = "<p>No hay conflictos registrados.</p>";
      }
    }

    function editarConflicto(id) {
      mostrarFormularioConflicto(id);
    }

    async function eliminarConflicto(id) {
      if (!confirm("¿Estás seguro de que deseas eliminar este conflicto?")) {
        return;
      }

      datosActuales.conflictos = datosActuales.conflictos.filter((c) => c.id !== id);
      datosActuales.entidades = datosActuales.entidades.filter(
        (e) => !datosActuales.conflictos.some((c) => c.entidades_involucradas.includes(e.id))
      );
      datosActuales.personas = datosActuales.personas.filter(
        (p) => !datosActuales.conflictos.some((c) => c.personas_involucradas.includes(p.id))
      );
      datosActuales.acciones = datosActuales.acciones.filter((a) => a.id_conflicto !== id);

      await actualizarDatos(datosActuales);
      mostrarConflictos();
      alert("Conflicto eliminado con éxito.");
    }

    function mostrarAcciones() {
      const contenedor = document.getElementById("acciones-contenedor")
      contenedor.innerHTML = ""
      
      if (!datosActuales || !datosActuales.acciones) {
        contenedor.innerHTML = "<p>No hay acciones registradas</p>"
        return
      }

      const accionesOrdenadas = [...datosActuales.acciones]
        .filter(accion => accion && accion.tipo_accion)
        .sort((a, b) => new Date(b.fecha) - new Date(a.fecha))

      accionesOrdenadas.forEach(accion => {
        const conflicto = datosActuales.conflictos.find(c => c.id === accion.id_conflicto)
        const tiempoTranscurrido = calcularTiempoTranscurrido(accion.fecha)
        
        const entidades = accion.entidades_relacionadas 
          ? accion.entidades_relacionadas
              .map(id => datosActuales.entidades.find(e => e.id === id))
              .filter(e => e)
              .map(e => e.nombre)
              .join(", ")
          : 'No especificadas'

        const card = document.createElement('div')
        card.className = 'accion-card clickable'
        card.onclick = () => mostrarFichaElemento('accion', accion.id)
        
        card.innerHTML = `
          <div style="display: flex; align-items: center; margin-bottom: 8px;">
            <span style="color: #f71616;">Hace ${tiempoTranscurrido}</span>
            <span style="color: #f71616; margin: 0 5px;">|</span>
            <span style="color: #f71616;">${capitalizarPrimeraLetra(accion.tipo_accion)}</span>
          </div>
          <p style="color: #000000; margin-bottom: 8px;">${accion.descripcion}</p>
          <div style="display: flex; align-items: center;">
            <span><strong>Conflicto:</strong> ${conflicto ? conflicto.titulo : 'No especificado'}</span>
            <span style="margin: 0 5px;">|</span>
            <span><strong>Partes:</strong> ${entidades}</span>
          </div>
        `
        
        contenedor.appendChild(card)
      })
    }

    function mostrarGestionPartes() {
      ocultarTodosLosContenedoresAdmin();
      document.getElementById('gestion-partes').classList.remove('hidden');
      cargarListaPartes();
    }

    function mostrarGestionPersonas() {
      ocultarTodosLosContenedoresAdmin();
      document.getElementById('gestion-personas').classList.remove('hidden');
      cargarListaPersonas();
    }

    function mostrarGestionAcciones() {
      ocultarTodosLosContenedoresAdmin();
      document.getElementById('gestion-acciones').classList.remove('hidden');
      cargarListaAcciones();
    }

    async function cargarListaPartes() {
      const contenedor = document.getElementById('lista-partes');
      contenedor.innerHTML = '';
      
      datosActuales.entidades.forEach(entidad => {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <strong>${entidad.nombre}</strong> (${entidad.tipo})
            </div>
            <div>
              <button onclick="editarEntidad(${entidad.id})">Editar</button>
              <button onclick="eliminarParte(${entidad.id})">Eliminar</button>
            </div>
          </div>
        `;
        contenedor.appendChild(div);
      });
    }

    async function cargarListaPersonas() {
      const contenedor = document.getElementById('lista-personas');
      contenedor.innerHTML = '';
      
      datosActuales.personas.forEach(persona => {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <strong>${persona.nombre}</strong> (${persona.rol})
            </div>
            <div>
              <button onclick="editarPersona(${persona.id})">Editar</button>
              <button onclick="eliminarPersona(${persona.id})">Eliminar</button>
            </div>
          </div>
        `;
        contenedor.appendChild(div);
      });
    }

    async function cargarListaAcciones() {
      const contenedor = document.getElementById('lista-acciones-admin');
      contenedor.innerHTML = '';
      
      datosActuales.acciones.forEach(accion => {
        const div = document.createElement('div');
        div.className = 'card';
        const conflicto = datosActuales.conflictos.find(c => c.id === accion.id_conflicto);
        div.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <strong>${capitalizarPrimeraLetra(accion.tipo_accion)}</strong> - ${accion.fecha}
              <br>
              <small>${conflicto ? conflicto.titulo : 'Sin conflicto'}</small>
            </div>
            <div>
              <button onclick="editarAccion(${accion.id})">Editar</button>
              <button onclick="eliminarAccion(${accion.id})">Eliminar</button>
            </div>
          </div>
        `;
        contenedor.appendChild(div);
      });
    }

    function ocultarTodosLosContenedoresAdmin() {
      document.getElementById('formulario-conflicto').classList.add('hidden');
      document.getElementById('lista-conflictos-admin').classList.add('hidden');
      document.getElementById('gestion-partes').classList.add('hidden');
      document.getElementById('gestion-personas').classList.add('hidden');
      document.getElementById('gestion-acciones').classList.add('hidden');
    }

    function agregarEntidadAConflicto() {
      // Lógica para agregar una entidad al conflicto
      const entidadId = prompt("Ingrese el ID de la entidad que desea agregar:");
      if (entidadId) {
        const entidad = datosActuales.entidades.find(e => e.id === parseInt(entidadId));
        if (entidad) {
          // Suponiendo que 'conflictoEditando' es el ID del conflicto actual
          const conflicto = datosActuales.conflictos.find(c => c.id === conflictoEditando);
          if (conflicto) {
            conflicto.entidades_involucradas.push(entidad.id);
            actualizarDatos(datosActuales); // Asegúrate de que esta función actualice los datos correctamente
            alert("Entidad agregada con éxito.");
          } else {
            alert("Conflicto no encontrado.");
          }
        } else {
          alert("Entidad no encontrada.");
        }
      }
    }

    function mostrarFormularioNuevaParte() {
      const formHTML = `
        <div class="form-overlay">
          <div class="form-modal">
            <h3>Agregar Nueva Parte</h3>
            <div class="form-group">
              <label for="nombre-parte">Nombre</label>
              <input type="text" id="nombre-parte" required>
            </div>
            <div class="form-group">
              <label for="tipo-parte">Tipo</label>
              <select id="tipo-parte">
                <option value="entidad">Entidad</option>
                <option value="persona">Persona</option>
              </select>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
              <button onclick="cerrarFormularioFlotante(this)">Cancelar</button>
              <button onclick="guardarParte(this)">Guardar</button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', formHTML);
    }

    function mostrarFormularioNuevaPersona() {
      const formHTML = `
        <div class="form-overlay">
          <div class="form-modal">
            <h3>Agregar Nueva Persona</h3>
            <div class="form-group">
              <label for="nombre-persona">Nombre</label>
              <input type="text" id="nombre-persona" required>
            </div>
            <div class="form-group">
              <label for="rol-persona">Rol</label>
              <select id="rol-persona">
                <option value="trabajador">Trabajador</option>
                <option value="delegado">Delegado</option>
                <option value="directivo">Directivo</option>
                <option value="funcionario">Funcionario</option>
                <option value="otro">Otro</option>
              </select>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
              <button onclick="cerrarFormularioFlotante(this)">Cancelar</button>
              <button onclick="guardarPersona(this)">Guardar</button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', formHTML);
    }

    function mostrarFormularioNuevaAccion() {
      const conflictosOptions = datosActuales.conflictos.map(conflicto => 
        `<option value="${conflicto.id}">${conflicto.titulo}</option>`
      ).join('');

      const entidadesOptions = datosActuales.entidades.map(entidad => 
        `<div>
          <input type="checkbox" id="entidad-${entidad.id}" value="${entidad.id}">
          <label for="entidad-${entidad.id}">${entidad.nombre}</label>
        </div>`
      ).join('');

      const personasOptions = datosActuales.personas.map(persona => 
        `<div>
          <input type="checkbox" id="persona-${persona.id}" value="${persona.id}">
          <label for="persona-${persona.id}">${persona.nombre}</label>
        </div>`
      ).join('');

      const formHTML = `
        <div class="form-overlay">
          <div class="form-modal">
            <h3>Agregar Nueva Acción</h3>
            <div class="form-group">
              <label for="tipo-accion">Tipo de Acción</label>
              <select id="tipo-accion">
                <option value="paro">Paro</option>
                <option value="movilización">Movilización</option>
                <option value="asamblea">Asamblea</option>
                <option value="negociación">Negociación</option>
                <option value="otro">Otro</option>
              </select>
            </div>
            <div class="form-group">
              <label for="descripcion-accion">Descripción</label>
              <textarea id="descripcion-accion" rows="3" required></textarea>
            </div>
            <div class="form-group">
              <label for="conflicto-accion">Conflicto Relacionado</label>
              <select id="conflicto-accion" required>
                <option value="">Seleccione un conflicto</option>
                ${conflictosOptions}
              </select>
            </div>
            <div class="form-group">
              <label>Partes Relacionadas</label>
              <div>${entidadesOptions}</div>
            </div>
            <div class="form-group">
              <label>Personas Relacionadas</label>
              <div>${personasOptions}</div>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
              <button onclick="cerrarFormularioFlotante(this)">Cancelar</button>
              <button onclick="guardarAccion(this)">Guardar</button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', formHTML);
    }

    function guardarAccion(element) {
      const form = element.closest('.form-modal');
      const tipo = form.querySelector('#tipo-accion').value;
      const descripcion = form.querySelector('#descripcion-accion').value;
      const conflictoId = form.querySelector('#conflicto-accion').value;
      const entidadesSeleccionadas = Array.from(form.querySelectorAll('input[type="checkbox"]:checked'))
        .map(checkbox => parseInt(checkbox.value));
      const personasSeleccionadas = Array.from(form.querySelectorAll('input[type="checkbox"]:checked'))
        .map(checkbox => parseInt(checkbox.value));

      if (!tipo || !descripcion || !conflictoId) {
        alert('Por favor, completa todos los campos requeridos.');
        return;
      }

      const nuevaAccion = {
        id: Date.now(), // Generar un ID único
        tipo_accion: tipo,
        descripcion,
        id_conflicto: parseInt(conflictoId),
        entidades_relacionadas: entidadesSeleccionadas,
        personas_relacionadas: personasSeleccionadas,
        fecha: new Date().toISOString() // Guardar la fecha actual
      };

      // Agregar la nueva acción a los datos actuales
      datosActuales.acciones.push(nuevaAccion);
      actualizarDatos(datosActuales); // Asegúrate de que esta función actualice los datos correctamente
      cerrarFormularioFlotante(element);
      alert("Acción guardada con éxito.");
    }

    function guardarParte(element) {
      const form = element.closest('.form-modal');
      const nombre = form.querySelector('#nombre-parte').value;
      const tipo = form.querySelector('#tipo-parte').value;

      if (!nombre) {
        alert('Por favor, completa el nombre de la parte.');
        return;
      }

      const nuevaParte = {
        id: Date.now(), // Generar un ID único
        nombre,
        tipo
      };

      // Agregar la nueva parte a los datos actuales
      datosActuales.entidades.push(nuevaParte);
      actualizarDatos(datosActuales); // Asegúrate de que esta función actualice los datos correctamente
      cerrarFormularioFlotante(element);
      alert("Parte guardada con éxito.");
    }

    // Asegurarse de que los datos se cargan al inicio
    window.onload = async function() {
      await cargarDatos()
      mostrarSeccion('acciones')
    };
  </script>
</body>
</html>
